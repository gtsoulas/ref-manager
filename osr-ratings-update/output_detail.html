{% extends 'base.html' %}

{% block title %}{{ output.title }} - REF Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">Output Details</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{% url 'output_update' output.pk %}" class="btn btn-sm btn-warning">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <a href="{% url 'output_delete' output.pk %}" class="btn btn-sm btn-danger" 
                   onclick="return confirm('Are you sure you want to delete this output?');">
                    <i class="fas fa-trash"></i> Delete
                </a>
            </div>
            <a href="{% url 'output_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Basic Information -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Title:</dt>
                        <dd class="col-sm-9">
                            <strong>{{ output.title }}</strong>
                        </dd>

                        <dt class="col-sm-3">All Authors:</dt>
                        <dd class="col-sm-9">{{ output.all_authors }}</dd>

                        <dt class="col-sm-3">Lead Author:</dt>
                        <dd class="col-sm-9">
                            {% if output.colleague.user %}
                                {{ output.colleague.user.get_full_name }}
                            {% else %}
                                {{ output.colleague.staff_id }}
                            {% endif %}
                            <small class="text-muted">(Position: {{ output.author_position }})</small>
                        </dd>

                        <dt class="col-sm-3">Publication Type:</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-secondary">
                                {{ output.get_publication_type_display }}
                            </span>
                        </dd>

                        <dt class="col-sm-3">Publication Date:</dt>
                        <dd class="col-sm-9">{{ output.publication_year}}</dd>
                    </dl>
                </div>
            </div>

            <!-- Publication Details -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-book"></i> Publication Details
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Venue:</dt>
                        <dd class="col-sm-9">
                            <strong>{{ output.publication_venue }}</strong>
                        </dd>

                        {% if output.volume %}
                        <dt class="col-sm-3">Volume:</dt>
                        <dd class="col-sm-9">{{ output.volume }}</dd>
                        {% endif %}

                        {% if output.issue %}
                        <dt class="col-sm-3">Issue:</dt>
                        <dd class="col-sm-9">{{ output.issue }}</dd>
                        {% endif %}

                        {% if output.pages %}
                        <dt class="col-sm-3">Pages:</dt>
                        <dd class="col-sm-9">{{ output.pages }}</dd>
                        {% endif %}

                        {% if output.doi %}
                        <dt class="col-sm-3">DOI:</dt>
                        <dd class="col-sm-9">
                            <a href="https://doi.org/{{ output.doi }}" target="_blank" rel="noopener">
                                {{ output.doi }} <i class="fas fa-external-link-alt fa-xs"></i>
                            </a>
                        </dd>
                        {% endif %}

                        {% if output.isbn %}
                        <dt class="col-sm-3">ISBN:</dt>
                        <dd class="col-sm-9">{{ output.isbn }}</dd>
                        {% endif %}

                        {% if output.url %}
                        <dt class="col-sm-3">URL:</dt>
                        <dd class="col-sm-9">
                            <a href="{{ output.url }}" target="_blank" rel="noopener">
                                {{ output.url|truncatewords:6 }} <i class="fas fa-external-link-alt fa-xs"></i>
                            </a>
                        </dd>
                        {% endif %}
                    </dl>

                    <!-- Citation -->
                    <hr>
                    <div class="alert alert-light mb-0">
                        <strong>Citation:</strong><br>
                        <small>{{ output.citation }}</small>
                    </div>
                </div>
            </div>

            <!-- REF Information -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-award"></i> REF Information
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Quality Rating:</dt>
                        <dd class="col-sm-9">
                            {% if output.quality_rating %}
                                <span class="badge 
                                    {% if output.quality_rating == '4*' %}bg-success
                                    {% elif output.quality_rating == '3*' %}bg-info
                                    {% elif output.quality_rating == '2*' %}bg-warning
                                    {% elif output.quality_rating == '1*' %}bg-secondary
                                    {% else %}bg-light text-dark
                                    {% endif %}">
                                    {{ output.quality_rating }}
                                </span>
                                <small class="text-muted ms-2">{{ output.get_quality_rating_display }}</small>
                            {% else %}
                                <span class="badge bg-light text-dark">Unclassified</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Status:</dt>
                        <dd class="col-sm-9">
                            <span class="badge 
                                {% if output.status == 'approved' %}bg-success
                                {% elif output.status == 'draft' %}bg-secondary
                                {% elif output.status == 'submitted' %}bg-info
                                {% elif output.status == 'internal-review' %}bg-warning
                                {% elif output.status == 'external-review' %}bg-primary
                                {% elif output.status == 'rejected' %}bg-danger
                                {% elif output.status == 'revision' %}bg-warning
                                {% else %}bg-secondary
                                {% endif %}">
                                {{ output.get_status_display }}
                            </span>
                        </dd>

                        <dt class="col-sm-3">Unit of Assessment:</dt>
                        <dd class="col-sm-9">{{ output.uoa }}</dd>

                        <dt class="col-sm-3">Flags:</dt>
                        <dd class="col-sm-9">
                            {% if output.is_double_weighted %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-star"></i> Double-weighted
                                </span>
                            {% endif %}
                            {% if output.is_interdisciplinary %}
                                <span class="badge bg-info">
                                    <i class="fas fa-network-wired"></i> Interdisciplinary
                                </span>
                            {% endif %}
                            {% if output.is_open_access %}
                                <span class="badge bg-success">
                                    <i class="fas fa-lock-open"></i> Open Access
                                </span>
                            {% endif %}
                            {% if not output.is_double_weighted and not output.is_interdisciplinary and not output.is_open_access %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- O/S/R Ratings Summary -->
            <div class="card mb-3">
                <div class="card-header bg-purple text-white" style="background-color: #6f42c1 !important;">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> O/S/R Ratings Summary (0.00-4.00 scale)
                    </h5>
                </div>
                <div class="card-body">
                    {% with breakdown=output.get_osr_breakdown %}
                    <div class="row text-center mb-3">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Originality</small>
                                <span class="h4 {% if breakdown.originality >= 3.5 %}text-success{% elif breakdown.originality >= 2.5 %}text-info{% elif breakdown.originality >= 1.5 %}text-warning{% elif breakdown.originality %}text-secondary{% else %}text-muted{% endif %}">
                                    {% if breakdown.originality %}{{ breakdown.originality }}{% else %}—{% endif %}
                                </span>
                                {% if breakdown.o_count %}<small class="text-muted d-block">({{ breakdown.o_count }} rating{{ breakdown.o_count|pluralize }})</small>{% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Significance</small>
                                <span class="h4 {% if breakdown.significance >= 3.5 %}text-success{% elif breakdown.significance >= 2.5 %}text-info{% elif breakdown.significance >= 1.5 %}text-warning{% elif breakdown.significance %}text-secondary{% else %}text-muted{% endif %}">
                                    {% if breakdown.significance %}{{ breakdown.significance }}{% else %}—{% endif %}
                                </span>
                                {% if breakdown.s_count %}<small class="text-muted d-block">({{ breakdown.s_count }} rating{{ breakdown.s_count|pluralize }})</small>{% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Rigour</small>
                                <span class="h4 {% if breakdown.rigour >= 3.5 %}text-success{% elif breakdown.rigour >= 2.5 %}text-info{% elif breakdown.rigour >= 1.5 %}text-warning{% elif breakdown.rigour %}text-secondary{% else %}text-muted{% endif %}">
                                    {% if breakdown.rigour %}{{ breakdown.rigour }}{% else %}—{% endif %}
                                </span>
                                {% if breakdown.r_count %}<small class="text-muted d-block">({{ breakdown.r_count }} rating{{ breakdown.r_count|pluralize }})</small>{% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted d-block"><strong>Overall</strong></small>
                                <span class="h4 {% if breakdown.overall >= 3.5 %}text-success{% elif breakdown.overall >= 2.5 %}text-info{% elif breakdown.overall >= 1.5 %}text-warning{% elif breakdown.overall %}text-secondary{% else %}text-muted{% endif %}">
                                    {% if breakdown.overall %}{{ breakdown.overall }}{% else %}—{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    
                    <!-- Combined Averages -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-light mb-0">
                                <strong>Combined Average (excl. self):</strong>
                                {% with avg=output.get_combined_osr_average %}
                                <span class="{% if avg >= 3.5 %}text-success{% elif avg >= 2.5 %}text-info{% elif avg >= 1.5 %}text-warning{% elif avg %}text-secondary{% else %}text-muted{% endif %} fw-bold">
                                    {% if avg %}{{ avg }}{% else %}—{% endif %}
                                </span>
                                {% endwith %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-light mb-0">
                                <strong>Combined Average (incl. self):</strong>
                                {% with avg=output.get_combined_osr_average_with_self %}
                                <span class="{% if avg >= 3.5 %}text-success{% elif avg >= 2.5 %}text-info{% elif avg >= 1.5 %}text-warning{% elif avg %}text-secondary{% else %}text-muted{% endif %} fw-bold">
                                    {% if avg %}{{ avg }}{% else %}—{% endif %}
                                </span>
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Abstract -->
            {% if output.abstract %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-align-left"></i> Abstract
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ output.abstract }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Keywords -->
            {% if output.keywords %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tags"></i> Keywords
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ output.keywords }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Internal Notes -->
            {% if output.internal_notes %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note"></i> Internal Notes
                    </h5>
                </div>
                <div class="card-body">
                    <pre class="mb-0" style="white-space: pre-wrap;">{{ output.internal_notes }}</pre>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Critical Friends -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-friends"></i> Critical Friends
                    </h5>
                </div>
                <div class="card-body">
                  {% if output.critical_friend_reviews.all %}
                  {% for assignment in output.critical_friend_reviews.all %}
                  <div class="mb-3 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
                    <strong>{{ assignment.critical_friend.name }}</strong><br>
                    <small class="text-muted">{{ assignment.critical_friend.institution }}</small><br>
                    <span class="badge bg-info mt-1">{{ assignment.get_status_display }}</span>
                    <!-- Three-component ratings -->
                    {% if assignment.originality_rating or assignment.significance_rating or assignment.rigour_rating %}
                    <div class="mt-2 small">
                        <strong>O:</strong> {{ assignment.originality_rating|default:"-" }} | 
                        <strong>S:</strong> {{ assignment.significance_rating|default:"-" }} | 
                        <strong>R:</strong> {{ assignment.rigour_rating|default:"-" }} | 
                        <strong>Avg:</strong> {{ assignment.component_average_rating|default:"-" }}
                    </div>
                    {% endif %}
                    {% if assignment.quality_assessment %}
                        <span class="badge bg-success mt-1">Rating: {{ assignment.quality_assessment }}</span>
                    {% endif %}
                    <br>
                    <div class="mt-2">
            <a href="{% url 'critical_friend_assignment_delete' assignment.pk %}" 
               class="btn btn-sm btn-outline-danger">
                <i class="fas fa-trash"></i> Delete
            </a>
        </div>
    </div>
    {% endfor %}
{% else %}
    <p class="text-muted mb-2">No critical friends assigned yet.</p>

                  {% endif %}
                        
                    <a href="{% url 'assign_critical_friend' output.pk %}" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-user-plus"></i> Assign Critical Friend
                    </a>
                </div>
            </div>

            <!-- Internal Evaluation Panel -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users"></i> Internal Evaluation Panel
                    </h5>
                </div>
                <div class="card-body">
                  {% if output.internal_panel_assignments.all %}
    {% for assignment in output.internal_panel_assignments.all %}
    <div class="mb-3 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
        <strong>{{ assignment.panel_member.colleague.user.get_full_name }}</strong><br>
        <small class="text-muted">{{ assignment.panel_member.get_role_display }}</small><br>
        <span class="badge bg-info mt-1">{{ assignment.get_status_display }}</span>
<!-- Three-component ratings -->
        {% if assignment.originality_rating or assignment.significance_rating or assignment.rigour_rating %}
        <div class="mt-2 small">
            <strong>O:</strong> {{ assignment.originality_rating|default:"-" }} | 
            <strong>S:</strong> {{ assignment.significance_rating|default:"-" }} | 
            <strong>R:</strong> {{ assignment.rigour_rating|default:"-" }} | 
            <strong>Avg:</strong> {{ assignment.component_average_rating|default:"-" }}
        </div>
        {% endif %}
        {% if assignment.rating_recommendation %}
            <span class="badge bg-success mt-1">Rec: {{ assignment.rating_recommendation }}</span>
        {% endif %}
        <br>
        <div class="mt-2">
            <a href="{% url 'internal_panel_assignment_update' assignment.pk %}" 
               class="btn btn-sm btn-outline-primary">
                <i class="fas fa-edit"></i> Update
            </a>
            <a href="{% url 'internal_panel_assignment_delete' assignment.pk %}" 
               class="btn btn-sm btn-outline-danger">
                <i class="fas fa-trash"></i> Delete
            </a>
        </div>
    </div>
    {% endfor %}
{% else %}
    <p class="text-muted mb-2">No panel members assigned yet.</p>
{% endif %}
                    <a href="{% url 'assign_internal_panel' output.pk %}" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-user-plus"></i> Assign Panel Member
                    </a>
                  </div>
            </div>

            <!-- Reviews -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-comments"></i> Reviews
                    </h5>
                </div>
                <div class="card-body">
                    {% if output.internal_reviews.all %}
                        <p class="mb-0">
                            <strong>{{ output.internal_reviews.count }}</strong> review(s)
                        </p>
                    {% else %}
                        <p class="text-muted mb-0">No reviews yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Files -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file"></i> Files
                    </h5>
                </div>
                <div class="card-body">
                    {% if output.pdf_file %}
                        <div class="mb-2">
                            <i class="fas fa-file-pdf text-danger"></i>
                            <a href="{{ output.pdf_file.url }}" target="_blank">
                                PDF File
                            </a>
                        </div>
                    {% endif %}
                    {% if output.supplementary_file %}
                        <div class="mb-2">
                            <i class="fas fa-paperclip"></i>
                            <a href="{{ output.supplementary_file.url }}" target="_blank">
                                Supplementary File
                            </a>
                        </div>
                    {% endif %}
                    {% if not output.pdf_file and not output.supplementary_file %}
                        <p class="text-muted mb-0">No files attached.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Metadata -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info"></i> Metadata
                    </h5>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <strong>Created:</strong> {{ output.created_at|date:"d M Y H:i" }}<br>
                        <strong>Updated:</strong> {{ output.updated_at|date:"d M Y H:i" }}
                        {% if output.submitted_date %}
                            <br><strong>Submitted:</strong> {{ output.submitted_date|date:"d M Y H:i" }}
                        {% endif %}
                        {% if output.approved_date %}
                            <br><strong>Approved:</strong> {{ output.approved_date|date:"d M Y H:i" }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
