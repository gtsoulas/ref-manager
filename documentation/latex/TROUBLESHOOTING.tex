\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{listings}

\geometry{margin=2.5cm}

\definecolor{refblue}{RGB}{0,82,147}
\definecolor{codebg}{RGB}{245,245,245}

\lstset{
    backgroundcolor=\color{codebg},
    basicstyle=\ttfamily\small,
    breaklines=true,
    frame=single,
}

\hypersetup{
    colorlinks=true,
    linkcolor=refblue,
    urlcolor=refblue,
    pdftitle={REF-Manager Troubleshooting},
    pdfauthor={George Tsoulas},
}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textit{REF-Manager Troubleshooting}}
\fancyhead[R]{\textit{Version 4.0}}
\fancyfoot[C]{\thepage}

\title{
    {\Huge\bfseries\color{refblue} REF-Manager}\\[0.3cm]
    {\LARGE Troubleshooting Guide}\\[0.5cm]
    {\large Version 4.0.0}
}
\author{George Tsoulas\\University of York}
\date{December 2025}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section{Installation Issues}

\subsection{``No module named 'requests'''}

\begin{lstlisting}
pip install requests
\end{lstlisting}

\subsection{Virtual environment not activating}

\begin{lstlisting}
# Linux/Mac
source venv/bin/activate

# Windows
venv\Scripts\activate
\end{lstlisting}

\section{Database Issues}

\subsection{``table already exists'' during migration}

\begin{lstlisting}
# Fake initial migration
python manage.py migrate --fake-initial

# Or fake all core migrations
python manage.py migrate core --fake

# Then apply new migrations
python manage.py makemigrations core
python manage.py migrate
\end{lstlisting}

\subsection{``no such column'' error}

\begin{lstlisting}
python manage.py showmigrations core
python manage.py makemigrations core
python manage.py migrate
\end{lstlisting}

\section{DOI Auto-Fetch Issues}

\subsection{``DOI not found in OpenAlex database''}

\begin{enumerate}
    \item Check DOI format -- should start with \texttt{10.}
    \item Test API directly:
\begin{lstlisting}
curl "https://api.openalex.org/works/doi:10.1038/nature12373"
\end{lstlisting}
    \item Very recent DOIs may not be indexed yet
\end{enumerate}

\subsection{Connection timeout}

\begin{enumerate}
    \item Check internet connection
    \item Check firewall/proxy settings
    \item OpenAlex API must be accessible
\end{enumerate}

\section{Server Deployment Issues}

\subsection{502 Bad Gateway}

\begin{lstlisting}
# Check Gunicorn status
sudo systemctl status gunicorn-ref-manager

# View logs
sudo journalctl -u gunicorn-ref-manager -n 50

# Restart
sudo systemctl restart gunicorn-ref-manager
\end{lstlisting}

\subsection{Static files not loading}

\begin{lstlisting}
python manage.py collectstatic --noinput
sudo systemctl restart nginx
\end{lstlisting}

\subsection{CSRF verification failed}

Add to settings:
\begin{lstlisting}[language=Python]
CSRF_TRUSTED_ORIGINS = [
    'https://your-domain.ac.uk',
]
\end{lstlisting}

\subsection{Permission denied}

\begin{lstlisting}
sudo chown -R www-data:www-data /var/www/ref-manager
sudo chmod -R 755 /var/www/ref-manager
\end{lstlisting}

\section{Log Files}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
\textbf{Log} & \textbf{Location} \\
\midrule
Django & \texttt{/var/www/ref-manager/logs/django.log} \\
Gunicorn & \texttt{/var/www/ref-manager/logs/gunicorn-*.log} \\
Nginx & \texttt{/var/log/nginx/ref-manager-*.log} \\
\bottomrule
\end{tabular}
\end{table}

\section{Health Check Commands}

\begin{lstlisting}
# Check services
sudo systemctl status gunicorn-ref-manager nginx postgresql

# Test database
python manage.py dbshell

# Check for issues
python manage.py check --deploy
\end{lstlisting}

\section{Getting Help}

\begin{itemize}
    \item Email: george.tsoulas@york.ac.uk
    \item GitHub: https://github.com/gtsoulas/ref-manager
\end{itemize}

\vfill
\begin{center}
{\small REF-Manager v4.0.0 -- George Tsoulas, University of York}
\end{center}

\end{document}
