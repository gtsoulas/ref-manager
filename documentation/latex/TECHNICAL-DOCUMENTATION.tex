\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage{tcolorbox}

\geometry{margin=2.5cm}

\definecolor{refblue}{RGB}{0,82,147}
\definecolor{codebg}{RGB}{248,248,248}
\definecolor{codeframe}{RGB}{200,200,200}
\definecolor{pythonblue}{RGB}{0,0,255}
\definecolor{pythongreen}{RGB}{0,128,0}

\hypersetup{
    colorlinks=true,
    linkcolor=refblue,
    urlcolor=refblue,
    pdftitle={REF-Manager Technical Documentation},
}

\lstset{
    basicstyle=\ttfamily\footnotesize,
    backgroundcolor=\color{codebg},
    frame=single,
    rulecolor=\color{codeframe},
    breaklines=true,
    columns=fullflexible,
    keywordstyle=\color{pythonblue},
    commentstyle=\color{pythongreen},
    language=Python
}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textit{REF-Manager Technical Documentation}}
\fancyhead[R]{\textit{Version 3.0}}
\fancyfoot[C]{\thepage}

\title{
    {\Huge\bfseries\color{refblue} REF-Manager}\\[0.5cm]
    {\LARGE Technical Documentation}\\[0.3cm]
    {\large Developer and Administrator Reference}
}
\author{University of York}
\date{November 2024}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section{Architecture Overview}

\subsection{Technology Stack}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
\textbf{Layer} & \textbf{Technology} \\
\midrule
Backend & Django 4.2, Python 3.10+ \\
Database & SQLite (dev), PostgreSQL (prod) \\
Frontend & Bootstrap 4, Chart.js \\
Forms & django-crispy-forms \\
Export & openpyxl, custom LaTeX \\
Server & Gunicorn, Nginx \\
Container & Docker \\
\bottomrule
\end{tabular}
\caption{Technology stack}
\end{table}

\subsection{Application Structure}

The application follows Django's standard project structure with two main apps:

\begin{itemize}
    \item \textbf{core}: Main application with models, views, and templates
    \item \textbf{reports}: Reporting, export, and portfolio optimisation
\end{itemize}

\section{Project Structure}

\begin{lstlisting}[language=bash]
ref-manager/
|-- config/              # Django project settings
|-- core/                # Main application
|   |-- models.py        # Database models
|   |-- views.py         # View controllers
|   |-- forms.py         # Form definitions
|   |-- templates/       # HTML templates
|   |-- management/      # Management commands
|   +-- migrations/      # Database migrations
|-- reports/             # Reporting module
|-- templates/           # Base templates
|-- static/              # Static assets
|-- documentation/       # Documentation
|-- docker-compose.yml   # Docker configuration
+-- requirements.txt     # Python dependencies
\end{lstlisting}

\section{Database Schema}

\subsection{Core Models}

\subsubsection{Colleague Model}

\begin{lstlisting}
class Colleague(models.Model):
    user = models.OneToOneField(User)
    staff_id = models.CharField(max_length=50, unique=True)
    fte = models.DecimalField(max_digits=3, decimal_places=2)
    contract_type = models.CharField(max_length=50)
    employment_status = models.CharField(max_length=10)
    colleague_category = models.CharField(max_length=50)
    unit_of_assessment = models.CharField(max_length=100)
    is_returnable = models.BooleanField(default=True)
\end{lstlisting}

\subsubsection{Output Model}

\begin{lstlisting}
class Output(models.Model):
    colleague = models.ForeignKey(Colleague)
    title = models.CharField(max_length=500)
    publication_type = models.CharField(max_length=1)
    publication_year = models.IntegerField()
    status = models.CharField(max_length=20)
    
    # Quality ratings
    quality_rating_internal = models.CharField(max_length=2)
    quality_rating_external = models.CharField(max_length=2)
    quality_rating_self = models.CharField(max_length=2)
    
    # Risk fields
    content_risk_score = models.DecimalField()
    timeline_risk_score = models.DecimalField()
    overall_risk_score = models.DecimalField()
\end{lstlisting}

\subsubsection{Access Control Models}

\begin{lstlisting}
class Role(models.Model):
    ROLE_CHOICES = [
        ('ADMIN', 'Administrator'),
        ('OBSERVER', 'Observer'),
        ('INTERNAL_PANEL', 'Internal Panel'),
        ('COLLEAGUE', 'Colleague'),
    ]
    code = models.CharField(max_length=20, unique=True)
    permissions = models.JSONField()

class UserProfile(models.Model):
    user = models.OneToOneField(User)
    roles = models.ManyToManyField(Role)
\end{lstlisting}

\section{Configuration}

\subsection{Environment Variables}

\begin{table}[h]
\centering
\begin{tabular}{lll}
\toprule
\textbf{Variable} & \textbf{Description} & \textbf{Default} \\
\midrule
DJANGO\_SECRET\_KEY & Secret key & Required \\
DEBUG & Debug mode & True \\
ALLOWED\_HOSTS & Allowed hosts & localhost \\
DB\_ENGINE & Database engine & sqlite3 \\
DB\_NAME & Database name & db.sqlite3 \\
DB\_USER & Database user & -- \\
DB\_PASSWORD & Database password & -- \\
\bottomrule
\end{tabular}
\caption{Environment variables}
\end{table}

\subsection{Production Settings}

\begin{lstlisting}
# Security settings
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_HSTS_SECONDS = 31536000
\end{lstlisting}

\section{Management Commands}

\subsection{setup\_roles}

Create default roles and user profiles.

\begin{lstlisting}[language=bash]
# Create roles only
python manage.py setup_roles

# Create profiles for existing users
python manage.py setup_roles --create-profiles

# Make superusers administrators
python manage.py setup_roles --superusers-admin
\end{lstlisting}

\subsection{assign\_roles}

Manage user role assignments.

\begin{lstlisting}[language=bash]
# List all users and roles
python manage.py assign_roles --list

# Add role
python manage.py assign_roles username --add ADMIN

# Set exact roles
python manage.py assign_roles username --set ADMIN

# Remove role
python manage.py assign_roles username --remove OBSERVER
\end{lstlisting}

\section{API Reference}

\subsection{View Mixins}

\begin{lstlisting}
from core.mixins import (
    AdminRequiredMixin,
    OutputAccessMixin,
    CanEditMixin,
)

class MyView(AdminRequiredMixin, ListView):
    model = Output
\end{lstlisting}

\subsection{Decorators}

\begin{lstlisting}
from core.decorators import (
    admin_required,
    permission_required,
)

@admin_required
def admin_view(request):
    pass

@permission_required('can_export_data')
def export_view(request):
    pass
\end{lstlisting}

\subsection{Template Tags}

\begin{lstlisting}[language=html]
{% load ref_permissions %}

{% if output|can_edit:user.ref_profile %}
    <a href="...">Edit</a>
{% endif %}

{% if user.ref_profile|has_permission:'can_export_data' %}
    <a href="...">Export</a>
{% endif %}
\end{lstlisting}

\section{Deployment}

\subsection{Docker Deployment}

\begin{lstlisting}[language=bash]
# Build and start
docker-compose up -d --build

# Run migrations
docker-compose exec web python manage.py migrate

# Create superuser
docker-compose exec web python manage.py createsuperuser
\end{lstlisting}

\subsection{Traditional Deployment}

\begin{lstlisting}[language=bash]
# Install dependencies
pip install -r requirements.txt
pip install gunicorn psycopg2-binary

# Run with Gunicorn
gunicorn config.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers 3
\end{lstlisting}

\section{Security}

\subsection{Production Checklist}

\begin{itemize}
    \item DEBUG = False
    \item Secure SECRET\_KEY
    \item HTTPS enforced
    \item Database password set
    \item ALLOWED\_HOSTS configured
    \item CSRF protection enabled
    \item Session cookies secure
\end{itemize}

\section{Maintenance}

\subsection{Database Backup}

\begin{lstlisting}[language=bash]
# PostgreSQL backup
pg_dump -U refuser refmanager > backup.sql

# Restore
psql -U refuser refmanager < backup.sql
\end{lstlisting}

\subsection{Log Locations}

\begin{itemize}
    \item Application: \texttt{/var/log/ref-manager/gunicorn.log}
    \item Nginx: \texttt{/var/log/nginx/}
    \item PostgreSQL: \texttt{/var/log/postgresql/}
\end{itemize}

\vfill
\begin{center}
\rule{0.5\textwidth}{0.4pt}\\[0.3cm]
{\small REF-Manager v3.0.0 --- GNU General Public License v3.0}
\end{center}

\end{document}
