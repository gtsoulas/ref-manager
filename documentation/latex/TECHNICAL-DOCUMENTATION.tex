\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{listings}

\geometry{margin=2.5cm}

\definecolor{refblue}{RGB}{0,82,147}
\definecolor{codebg}{RGB}{245,245,245}

\lstset{
    backgroundcolor=\color{codebg},
    basicstyle=\ttfamily\small,
    breaklines=true,
    frame=single,
    rulecolor=\color{gray},
}

\hypersetup{
    colorlinks=true,
    linkcolor=refblue,
    urlcolor=refblue,
    pdftitle={REF-Manager Technical Documentation},
    pdfauthor={George Tsoulas},
}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textit{REF-Manager Technical Documentation}}
\fancyhead[R]{\textit{Version 4.0}}
\fancyfoot[C]{\thepage}

\title{
    {\Huge\bfseries\color{refblue} REF-Manager}\\[0.3cm]
    {\LARGE Technical Documentation}\\[0.3cm]
    {\large Developer and Administrator Reference}\\[0.5cm]
    {\large Version 4.0.0}
}
\author{George Tsoulas\\University of York}
\date{December 2025}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section{Architecture Overview}

\subsection{Technology Stack}

\begin{table}[h]
\centering
\begin{tabular}{ll}
\toprule
\textbf{Component} & \textbf{Technology} \\
\midrule
Framework & Django 4.2 LTS \\
Language & Python 3.10+ \\
Database & SQLite (dev) / PostgreSQL 15 (prod) \\
Web Server & Nginx \\
WSGI Server & Gunicorn \\
Frontend & Bootstrap 5, Chart.js \\
\bottomrule
\end{tabular}
\end{table}

\section{Server Deployment}

\subsection{System Packages}

\begin{lstlisting}
sudo apt update && sudo apt upgrade -y
sudo apt install -y \
    python3.12 python3.12-venv \
    postgresql postgresql-contrib \
    nginx certbot python3-certbot-nginx git
\end{lstlisting}

\subsection{PostgreSQL Setup}

\begin{lstlisting}
sudo -u postgres psql

CREATE DATABASE ref_manager;
CREATE USER ref_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE ref_manager TO ref_user;
\q
\end{lstlisting}

\subsection{Application Setup}

\begin{lstlisting}
sudo mkdir -p /var/www/ref-manager
cd /var/www/ref-manager

git clone https://github.com/gtsoulas/ref-manager.git .
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install gunicorn psycopg2-binary requests

mkdir -p static media logs
\end{lstlisting}

\subsection{Environment Configuration}

Create \texttt{/var/www/ref-manager/.env}:

\begin{lstlisting}
DEBUG=False
SECRET_KEY=your-secure-secret-key
ALLOWED_HOSTS=your-domain.ac.uk
DATABASE_URL=postgres://ref_user:password@localhost:5432/ref_manager
STATIC_ROOT=/var/www/ref-manager/static
MEDIA_ROOT=/var/www/ref-manager/media
\end{lstlisting}

\subsection{Gunicorn Service}

Create \texttt{/etc/systemd/system/gunicorn-ref-manager.service}:

\begin{lstlisting}
[Unit]
Description=Gunicorn daemon for REF-Manager
After=network.target

[Service]
User=www-data
WorkingDirectory=/var/www/ref-manager
ExecStart=/var/www/ref-manager/venv/bin/gunicorn \
    --bind 127.0.0.1:8000 \
    --workers 4 \
    config.wsgi:application
Restart=always

[Install]
WantedBy=multi-user.target
\end{lstlisting}

Enable and start:

\begin{lstlisting}
sudo systemctl daemon-reload
sudo systemctl enable gunicorn-ref-manager
sudo systemctl start gunicorn-ref-manager
\end{lstlisting}

\subsection{Nginx Configuration}

Create \texttt{/etc/nginx/sites-available/ref-manager}:

\begin{lstlisting}
server {
    listen 443 ssl http2;
    server_name your-domain.ac.uk;

    ssl_certificate /etc/letsencrypt/live/.../fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/.../privkey.pem;

    location /static/ {
        alias /var/www/ref-manager/static/;
    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $http_host;
    }
}
\end{lstlisting}

\section{Database Schema (v4.0)}

\subsection{New O/S/R Fields}

\begin{lstlisting}[language=Python]
# Self-Assessment
originality_self = DecimalField(max_digits=3, decimal_places=2)
significance_self = DecimalField(max_digits=3, decimal_places=2)
rigour_self = DecimalField(max_digits=3, decimal_places=2)

# Internal Panel
originality_internal = DecimalField(...)
significance_internal = DecimalField(...)
rigour_internal = DecimalField(...)

# External (Critical Friend)
originality_external = DecimalField(...)
significance_external = DecimalField(...)
rigour_external = DecimalField(...)
\end{lstlisting}

\subsection{OA Compliance Fields}

\begin{lstlisting}[language=Python]
acceptance_date = DateField(null=True)
deposit_date = DateField(null=True)
embargo_end_date = DateField(null=True)
oa_status = CharField(choices=OA_STATUS_CHOICES)
oa_exception = CharField(choices=OA_EXCEPTION_CHOICES)
\end{lstlisting}

\section{API Reference}

\subsection{DOI Metadata Endpoint}

\begin{itemize}
    \item \textbf{URL}: \texttt{/outputs/fetch-doi/}
    \item \textbf{Method}: GET
    \item \textbf{Parameter}: \texttt{doi} -- DOI to look up
\end{itemize}

Response:
\begin{lstlisting}
{
  "success": true,
  "data": {
    "title": "Paper Title",
    "publication_year": 2024,
    "all_authors": "Smith, J., Jones, A.",
    "oa_status": "gold"
  }
}
\end{lstlisting}

\section{Backup \& Recovery}

\subsection{Database Backup}

\begin{lstlisting}
pg_dump -U ref_user ref_manager > backup.sql
\end{lstlisting}

\subsection{Restore}

\begin{lstlisting}
psql -U ref_user ref_manager < backup.sql
\end{lstlisting}

\section{Contact}

\begin{itemize}
    \item \textbf{Author}: George Tsoulas
    \item \textbf{Email}: george.tsoulas@york.ac.uk
    \item \textbf{GitHub}: https://github.com/gtsoulas/ref-manager
\end{itemize}

\vfill
\begin{center}
{\small REF-Manager v4.0.0 Technical Documentation}\\
{\small George Tsoulas, University of York}
\end{center}

\end{document}
