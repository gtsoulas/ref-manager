{% comment %}
Template: templates/core/output_detail_ratings.html

Ratings section for output detail page with proper visibility controls.

Include this in your output_detail.html where ratings are displayed.

Visibility Rules:
- Internal Panel ratings: 
  - Numeric O/S/R values and average visible to ALL
  - Confidential comments visible ONLY to: Admin, Observer, Panel Members
- Critical Friend ratings:
  - EVERYTHING visible ONLY to: Admin, Observer
  - NOT visible to: Panel Members, Colleagues
{% endcomment %}

{% load ref_permissions %}

<div class="ratings-section mt-4">
    <h4>Quality Assessments</h4>
    <hr>
    
    {# ============================================================ #}
    {# INTERNAL PANEL RATINGS - Numeric values visible to all       #}
    {# ============================================================ #}
    
    {% if output.internal_panel_assignments.exists %}
        <h5 class="mt-4">
            <i class="fas fa-users"></i> Internal Panel Reviews
            <span class="badge badge-primary">{{ output.internal_panel_assignments.count }}</span>
        </h5>
        
        {% for assignment in output.internal_panel_assignments.all %}
            <div class="card mb-3 border-primary">
                <div class="card-header bg-primary text-white">
                    <strong>{{ assignment.panel_member.colleague }}</strong>
                    <span class="badge badge-light ml-2">{{ assignment.reviewer_type|title }}</span>
                    <span class="badge badge-{{ assignment.status }} float-right">{{ assignment.get_status_display }}</span>
                </div>
                <div class="card-body">
                    {# Numeric ratings - VISIBLE TO ALL #}
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Originality</small>
                                <span class="h4">{{ assignment.originality_rating|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Significance</small>
                                <span class="h4">{{ assignment.significance_rating|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Rigour</small>
                                <span class="h4">{{ assignment.rigour_rating|default:"-" }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted d-block">Average</small>
                                <span class="h4 text-primary"><strong>{{ assignment.component_average_rating|default:"-" }}</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    {# Public comments - VISIBLE TO ALL #}
                    {% if assignment.comments %}
                    <div class="mt-3">
                        <label class="text-muted"><small>Comments:</small></label>
                        <p>{{ assignment.comments }}</p>
                    </div>
                    {% endif %}
                    
                    {# Confidential comments - ONLY Admin, Observer, Panel Members #}
                    {% if assignment.confidential_comments %}
                        {% if user.ref_profile.is_admin or user.ref_profile.is_observer or user.ref_profile.is_panel_member %}
                        <div class="mt-3 alert alert-warning">
                            <small class="text-muted">
                                <i class="fas fa-lock"></i> Confidential Comments 
                                <em>(not visible to output author)</em>
                            </small>
                            <p class="mb-0 mt-2">{{ assignment.confidential_comments }}</p>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-footer text-muted small">
                    Assigned: {{ assignment.assigned_date }}
                    {% if assignment.review_date %} | Reviewed: {{ assignment.review_date }}{% endif %}
                </div>
            </div>
        {% endfor %}
        
        {# Internal Panel Summary #}
        {% with assignments=output.internal_panel_assignments.all %}
            {% if assignments %}
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <strong>Internal Panel Summary:</strong>
                    {% with avg=output.get_internal_panel_average %}
                        <span class="h5 ml-3">Average: {{ avg|default:"-" }}</span>
                    {% endwith %}
                </div>
            </div>
            {% endif %}
        {% endwith %}
    {% else %}
        <div class="alert alert-secondary">
            <i class="fas fa-info-circle"></i> No internal panel reviews yet.
        </div>
    {% endif %}
    
    
    {# ============================================================ #}
    {# CRITICAL FRIEND RATINGS - ONLY visible to Admin & Observer   #}
    {# ============================================================ #}
    
    {% if user.ref_profile.is_admin or user.ref_profile.is_observer %}
        
        {% if output.critical_friend_reviews.exists %}
            <h5 class="mt-4">
                <i class="fas fa-user-friends"></i> Critical Friend Reviews
                <span class="badge badge-info">{{ output.critical_friend_reviews.count }}</span>
                <small class="text-muted ml-2">
                    <i class="fas fa-eye-slash"></i> Visible only to Admin/Observer
                </small>
            </h5>
            
            {% for assignment in output.critical_friend_reviews.all %}
                <div class="card mb-3 border-info">
                    <div class="card-header bg-info text-white">
                        <strong>{{ assignment.critical_friend.name }}</strong>
                        <small class="ml-2">({{ assignment.critical_friend.institution }})</small>
                        <span class="badge badge-light ml-2">{{ assignment.reviewer_type|title }}</span>
                        <span class="badge badge-{{ assignment.status }} float-right">{{ assignment.get_status_display }}</span>
                    </div>
                    <div class="card-body">
                        {# Numeric ratings #}
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Originality</small>
                                    <span class="h4">{{ assignment.originality_rating|default:"-" }}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Significance</small>
                                    <span class="h4">{{ assignment.significance_rating|default:"-" }}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <small class="text-muted d-block">Rigour</small>
                                    <span class="h4">{{ assignment.rigour_rating|default:"-" }}</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2 bg-light">
                                    <small class="text-muted d-block">Average</small>
                                    <span class="h4 text-info"><strong>{{ assignment.component_average_rating|default:"-" }}</strong></span>
                                </div>
                            </div>
                        </div>
                        
                        {# Detailed feedback sections #}
                        {% if assignment.strengths %}
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="text-success"><strong>Strengths</strong></label>
                                <p>{{ assignment.strengths }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-danger"><strong>Weaknesses</strong></label>
                                <p>{{ assignment.weaknesses }}</p>
                            </div>
                            <div class="col-md-4">
                                <label class="text-info"><strong>Suggestions</strong></label>
                                <p>{{ assignment.suggestions }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if assignment.overall_comments %}
                        <div class="mt-3">
                            <label class="text-muted"><small>Overall Comments:</small></label>
                            <p>{{ assignment.overall_comments }}</p>
                        </div>
                        {% endif %}
                        
                        {# Confidential comments #}
                        {% if assignment.confidential_comments %}
                        <div class="mt-3 alert alert-secondary">
                            <small class="text-muted">
                                <i class="fas fa-lock"></i> Confidential Comments
                            </small>
                            <p class="mb-0 mt-2">{{ assignment.confidential_comments }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer text-muted small">
                        Assigned: {{ assignment.assigned_date|date }}
                        {% if assignment.completed_date %} | Completed: {{ assignment.completed_date|date }}{% endif %}
                    </div>
                </div>
            {% endfor %}
            
            {# Critical Friend Summary #}
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <strong>Critical Friend Summary:</strong>
                    {% with avg=output.get_critical_friend_average %}
                        <span class="h5 ml-3">Average: {{ avg|default:"-" }}</span>
                    {% endwith %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-secondary mt-4">
                <i class="fas fa-info-circle"></i> No critical friend reviews yet.
                <small class="text-muted">(Admin/Observer view)</small>
            </div>
        {% endif %}
        
    {% else %}
        {# Non-admin/observer users see nothing about critical friend reviews #}
        {# This intentionally shows no indication that CF reviews exist #}
    {% endif %}
    
</div>
